#+Title: Router role
#+Author: Systems Team
#+SETUPFILE: ../../org-templates/level-2.org
#+TAGS: boilerplate(b)
#+EXCLUDE_TAGS: boilerplate
#+OPTIONS: ^:nil


* Introduction
  This document describes the automation of router  creation.
* Implementation
** Automate Router node configuration
*** Router role
#+BEGIN_SRC yml :tangle roles/router/tasks/main.yml

---

- name: Set root password
  shell: vzctl set 1001 --userpasswd root:test

- name: copy interface ifcfg-eth0 file
  copy: src=ifcfg-eth0 dest=/vz/private/1001/etc/sysconfig/network-scripts/
  
- name: copy interface ifcfg-eth1 file
  copy: src=ifcfg-eth1 dest=/vz/private/1001/etc/sysconfig/network-scripts/

- name: Router's Network restart
  command: vzctl exec 1001 service network restart

- name: Set iptable rule 
  command: vzctl exec 1001 iptables -t nat -A POSTROUTING ! -d 10.100.0.0/22 -o eth0 -j SNAT --to-source 10.2.59.221

- name: iptables Saving 
  command: vzctl exec 1001 iptables-save > /etc/sysconfig/iptables

- name: ipv4 forwarding in router
  replace:
     path: /vz/private/1001/etc/sysctl.conf
     regexp: 'net.ipv4.ip_forward = 0'
     replace: 'net.ipv4.ip_forward = 1'

- name: reboot
  command: vzctl restart 1001
  register: out
- debug: var=out.stdout_lines


#+END_SRC

#+BEGIN_SRC yml :tangle roles/router/meta/main.yml

dependencies:
    - common-vars

#+END_SRC

#+BEGIN_SRC yml :tangle roles/router/files/ifcfg-eth0

DEVICE=eth0
TYPE=Ethernet
BOOTPROTO=static
ONBOOT=yes
NM_CONTROLLED=no
IPADDR=10.2.59.221
NETMASK=255.255.252.0
GATEWAY=10.2.56.1
DNS1=10.4.12.160
DNS2=10.4.12.220


#+END_SRC

#+BEGIN_SRC yml :tangle roles/router/files/ifcfg-eth1

DEVICE=eth1
BOOTPROTO=static
ONBOOT=yes
NM_CONTROLLED=no
IPADDR=10.100.1.1
NETMASK=255.255.252.0


#+END_SRC

  



    
  

    
